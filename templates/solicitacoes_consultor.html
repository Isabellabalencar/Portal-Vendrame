<!-- templates/solicitacoes_consultor.html -->
<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Solicitações em Andamento | Portal Vendrame</title>

    <link rel="icon" href="{{ url_for('static', filename='assets/icone.png') }}" type="image/png" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/solicitacoes_consultor.css') }}" />
    <script defer src="{{ url_for('static', filename='js/solicitacoes_consultor.js') }}"></script>
  </head>

  <body>
    <header class="topbar">
      <a class="back" href="{{ url_for('home_router.dashboard') }}">← Voltar</a>
      <div class="brand">
        <h1>Solicitações em Andamento</h1>
      </div>
      <div></div>
    </header>

    <main class="page">
      <!-- filtros (mesma estrutura da tela do cliente) -->
      <section class="filters">
        <!-- Buscar por nome ou CPF -->
        <div class="filter">
          <label for="q">Buscar</label>
          <div class="search">
            <span class="ico" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="7" stroke="#64748b" stroke-width="2"/>
                <path d="M20 20l-3.5-3.5" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>

            <input
              type="text"
              id="q"
              placeholder="Pesquisar por nome ou CPF"
              autocomplete="off"
            />
          </div>
        </div>

        <!-- Tipo -->
        <div class="f">
          <label for="f_tipo">Selecione o Tipo de Exame</label>
          <select id="f_tipo">
            <option value="Todos" selected>Todos</option>
            {% for t in tipos %}
              <option value="{{ t }}">{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Protocolo -->
        <div class="f">
          <label for="f_protocolo">Selecione o protocolo</label>
          <select id="f_protocolo">
            <option value="Todos" selected>Todos</option>
            {% for p in protocolos %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Status -->
        <div class="f">
          <label for="f_status">Selecione o Status</label>
          <select id="f_status">
            <option value="Todos" selected>Todos</option>
            <option value="Em Aberto">Em Aberto</option>
            <option value="Em Andamento">Em Andamento</option>
            <option value="Finalizado">Finalizado</option>
            <option value="Não Aprovado">Não Aprovado</option>
          </select>
        </div>
      </section>

      <!-- lista -->
      <section class="list" id="list">
        {% for s in solicitacoes %}
        <article
          class="req-card"
          data-user="{{ (s.funcionario or '')|lower }}"
          data-cpf="{{ (s.cpf or '')|lower }}"
          data-tipo="{{ (s.tipo_exame or '')|lower }}"
          data-proto="{{ (s.protocolo or '')|lower }}"
          data-status="{{ (s.status or '')|lower }}"
          data-origem="{{ (s._origem or '') }}"
        >
          <div class="req-head">
            <div class="proto">
              <span class="lbl">Protocolo:</span>
              <span class="val">{{ s.protocolo }}</span>

              {% if s.status %}
                <!-- mantém seu padrão atual; JS normaliza e o CSS já tem fallback -->
                <span class="badge badge-{{ (s.status or '')|lower|replace(' ','-') }}">
                  {{ s.status }}
                </span>
              {% endif %}
            </div>

            <button class="toggle" type="button" aria-expanded="false">
              Detalhes
              <span class="chev" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M6 9l6 6 6-6" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </button>
          </div>

          <div class="req-body" hidden>
            <!-- ===========================
                 DETALHES (por tipo de exame)
                 =========================== -->
            <div class="grid">
              {% set tipo = (s.tipo_exame or '')|lower %}

              {% if tipo == 'admissional' %}

                <div class="item"><span>Tipo de Exame:</span> <strong>{{ s.tipo_exame or "-" }}</strong></div>
                <div class="item"><span>Empresa:</span> <strong>{{ s.empresa or "-" }}</strong></div>
                <div class="item"><span>Unidade:</span> <strong>{{ s.unidade or "-" }}</strong></div>

                <div class="item"><span>Centro de custo:</span> <strong>{{ s.centro_custo or "-" }}</strong></div>
                <div class="item"><span>Código RH:</span> <strong>{{ s.codigo_rh or "-" }}</strong></div>
                <div class="item"><span>Local para agendar:</span> <strong>{{ s.local_agendar or "-" }}</strong></div>

                <div class="item"><span>Funcionário:</span> <strong>{{ s.funcionario or "-" }}</strong></div>
                <div class="item"><span>CPF:</span> <strong>{{ s.cpf or "-" }}</strong></div>
                <div class="item"><span>RG:</span> <strong>{{ s.rg or "-" }}</strong></div>

                <div class="item"><span>Data de preferência:</span> <strong>{{ s.data_preferencia or "-" }}</strong></div>
                <div class="item"><span>Telefone:</span> <strong>{{ s.telefone or "-" }}</strong></div>
                <div class="item"><span>CNPJ:</span> <strong>{{ s.cnpj or "-" }}</strong></div>

                <div class="item"><span>Nascimento:</span> <strong>{{ s.nascimento or "-" }}</strong></div>
                <div class="item"><span>Admissão:</span> <strong>{{ s.admissao or "-" }}</strong></div>
                <div class="item"><span>Função:</span> <strong>{{ s.funcao or "-" }}</strong></div>

                <div class="item"><span>Setor:</span> <strong>{{ s.setor or "-" }}</strong></div>

              {% elif tipo == 'avaliação médica' or tipo == 'avaliacao medica' %}

                <div class="item"><span>Tipo de Exame:</span> <strong>{{ s.tipo_exame or "-" }}</strong></div>
                <div class="item"><span>Empresa:</span> <strong>{{ s.empresa or "-" }}</strong></div>
                <div class="item"><span>Funcionário:</span> <strong>{{ s.funcionario or "-" }}</strong></div>

                <div class="item"><span>Telefone:</span> <strong>{{ s.telefone or "-" }}</strong></div>
                <div class="item"><span>CPF:</span> <strong>{{ s.cpf or "-" }}</strong></div>
                <div class="item"><span>Local para agendar:</span> <strong>{{ s.local_agendar or "-" }}</strong></div>

                <div class="item"><span>Data de preferência:</span> <strong>{{ s.data_preferencia or "-" }}</strong></div>

                {% if s.forma_justificativa %}
                  <div class="item"><span>Forma da justificativa:</span> <strong>{{ s.forma_justificativa }}</strong></div>
                {% endif %}

                {% if (s.forma_justificativa or '')|lower == 'texto' and s.justificativa_texto %}
                  <div class="item"><span>Justificativa:</span> <strong>{{ s.justificativa_texto }}</strong></div>
                {% endif %}

                {% if s.nome_arquivo %}
                  <div class="item"><span>Arquivo enviado:</span> <strong>{{ s.nome_arquivo }}</strong></div>
                {% endif %}

              {% elif tipo == 'demissional' %}

                <div class="item"><span>Tipo de Exame:</span> <strong>{{ s.tipo_exame or "-" }}</strong></div>
                <div class="item"><span>Empresa:</span> <strong>{{ s.empresa or "-" }}</strong></div>
                <div class="item"><span>Funcionário:</span> <strong>{{ s.funcionario or "-" }}</strong></div>

                <div class="item"><span>CPF:</span> <strong>{{ s.cpf or "-" }}</strong></div>
                <div class="item"><span>Telefone:</span> <strong>{{ s.telefone or "-" }}</strong></div>
                <div class="item"><span>Local para agendar:</span> <strong>{{ s.local_agendar or "-" }}</strong></div>

                <div class="item"><span>Data de preferência:</span> <strong>{{ s.data_preferencia or "-" }}</strong></div>

              {% elif tipo == 'mudança de riscos' or tipo == 'mudanca de riscos' or tipo == 'mudança de riscos ocupacionais' or tipo == 'mudanca de riscos ocupacionais' %}

                <div class="item"><span>Tipo de Exame:</span> <strong>{{ s.tipo_exame or "-" }}</strong></div>
                <div class="item"><span>Empresa:</span> <strong>{{ s.empresa or "-" }}</strong></div>
                <div class="item"><span>Funcionário:</span> <strong>{{ s.funcionario or "-" }}</strong></div>

                <div class="item"><span>Telefone:</span> <strong>{{ s.telefone or "-" }}</strong></div>
                <div class="item"><span>CPF:</span> <strong>{{ s.cpf or "-" }}</strong></div>
                <div class="item"><span>Local para agendar:</span> <strong>{{ s.local_agendar or "-" }}</strong></div>

                <div class="item"><span>Data de preferência:</span> <strong>{{ s.data_preferencia or "-" }}</strong></div>

                <div class="item"><span>Unidade anterior:</span> <strong>{{ s.unidade_anterior or "-" }}</strong></div>
                <div class="item"><span>Setor anterior:</span> <strong>{{ s.setor_anterior or "-" }}</strong></div>
                <div class="item"><span>Cargo anterior:</span> <strong>{{ s.cargo_anterior or "-" }}</strong></div>

                <div class="item"><span>Unidade atual:</span> <strong>{{ s.unidade_atual or "-" }}</strong></div>
                <div class="item"><span>Setor atual:</span> <strong>{{ s.setor_atual or "-" }}</strong></div>
                <div class="item"><span>Cargo atual:</span> <strong>{{ s.cargo_atual or "-" }}</strong></div>

              {% elif tipo == 'periódico' or tipo == 'periodico' %}

                <div class="item"><span>Tipo de Exame:</span> <strong>{{ s.tipo_exame or "-" }}</strong></div>
                <div class="item"><span>Empresa:</span> <strong>{{ s.empresa or "-" }}</strong></div>
                <div class="item"><span>Funcionário:</span> <strong>{{ s.funcionario or "-" }}</strong></div>

                <div class="item"><span>CPF:</span> <strong>{{ s.cpf or "-" }}</strong></div>
                <div class="item"><span>Telefone:</span> <strong>{{ s.telefone or "-" }}</strong></div>
                <div class="item"><span>Local para agendar:</span> <strong>{{ s.local_agendar or "-" }}</strong></div>

                <div class="item"><span>Data de preferência:</span> <strong>{{ s.data_preferencia or "-" }}</strong></div>

              {% elif tipo == 'retorno ao trabalho' or tipo == 'retorno_trabalho' or tipo == 'retorno trabalho' %}

                <div class="item"><span>Tipo de Exame:</span> <strong>{{ s.tipo_exame or "-" }}</strong></div>
                <div class="item"><span>Empresa:</span> <strong>{{ s.empresa or "-" }}</strong></div>
                <div class="item"><span>Funcionário:</span> <strong>{{ s.funcionario or "-" }}</strong></div>

                <div class="item"><span>CPF:</span> <strong>{{ s.cpf or "-" }}</strong></div>
                <div class="item"><span>Telefone:</span> <strong>{{ s.telefone or "-" }}</strong></div>
                <div class="item"><span>Local para agendar:</span> <strong>{{ s.local_agendar or "-" }}</strong></div>

                <div class="item"><span>Data de preferência:</span> <strong>{{ s.data_preferencia or "-" }}</strong></div>

                {% if s.rt_nome_arquivo %}
                  <div class="item"><span>Arquivo enviado:</span> <strong>{{ s.rt_nome_arquivo }}</strong></div>
                {% endif %}

              {% else %}

                <div class="item"><span>Tipo de Exame:</span> <strong>{{ s.tipo_exame or "-" }}</strong></div>
                <div class="item"><span>Nome da empresa:</span> <strong>{{ s.empresa or "-" }}</strong></div>
                <div class="item"><span>Nome do funcionário:</span> <strong>{{ s.funcionario or "-" }}</strong></div>

                <div class="item"><span>Telefone:</span> <strong>{{ s.telefone or "-" }}</strong></div>
                <div class="item"><span>Local para agendar:</span> <strong>{{ s.local_agendar or "-" }}</strong></div>
                <div class="item"><span>Data de preferência do exame:</span> <strong>{{ s.data_preferencia or "-" }}</strong></div>

                <div class="item"><span>CPF:</span> <strong>{{ s.cpf or "-" }}</strong></div>
                <div class="item"><span>RG:</span> <strong>{{ s.rg or "-" }}</strong></div>
                <div class="item"><span>Profissional:</span> <strong>{{ s.profissional or "-" }}</strong></div>

              {% endif %}

              <!-- ✅ NOVO: última resposta do consultor (para QUALQUER TIPO) -->
              <div class="item item-wide">
                <span>Última resposta do consultor:</span>
                <strong>{{ s.resposta_consultor or "-" }}</strong>
              </div>
            </div>

            <!-- Documentos -->
            <div class="docs">
              <div class="docs-title">
                <input type="checkbox" checked disabled />
                <span>Documentos disponíveis:</span>
              </div>

              {% if s.documentos and s.documentos|length > 0 %}
                <ul class="docs-list">
                  {% for d in s.documentos %}
                    <li>
                      {% if d.stored_name == '__avaliacao_db__' %}
                        <a href="{{ url_for('minhas_solicitacoes.baixar_documento_avaliacao', protocolo=s.protocolo) }}">
                          {{ d.filename }}
                        </a>
                      {% elif d.stored_name == '__retorno_db__' %}
                        <a href="{{ url_for('minhas_solicitacoes.baixar_documento_retorno', protocolo=s.protocolo) }}">
                          {{ d.filename }}
                        </a>
                      {% else %}
                        <a href="{{ url_for('minhas_solicitacoes.baixar_documento', protocolo=s.protocolo, stored_name=d.stored_name) }}">
                          {{ d.filename }}
                        </a>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="docs-empty">Nenhum documento anexado</p>
              {% endif %}
            </div>

            <!-- Atualizar status -->
            <div class="status-box">
              <div class="status-title">Atualizar Status</div>

              <div class="status-row">
                <select
                  class="status-select"
                  data-protocolo="{{ s.protocolo }}"
                  data-origem="{{ s._origem }}"
                >
                  <option value="Em Aberto" {% if (s.status or '') == 'Em Aberto' %}selected{% endif %}>Em Aberto</option>
                  <option value="Em Andamento" {% if (s.status or '') == 'Em Andamento' %}selected{% endif %}>Em Andamento</option>
                  <option value="Finalizado" {% if (s.status or '') == 'Finalizado' %}selected{% endif %}>Finalizado</option>
                  <option value="Não Aprovado" {% if (s.status or '') == 'Não Aprovado' %}selected{% endif %}>Não Aprovado</option>
                </select>

                <!-- ✅ classe específica para salvar STATUS -->
                <button
                  class="btn-save-status"
                  type="button"
                  data-protocolo="{{ s.protocolo }}"
                  data-origem="{{ s._origem }}"
                >
                  Salvar
                </button>
              </div>

              <p class="status-hint">
                Ao salvar, o status do protocolo será atualizado na base correspondente.
              </p>
            </div>

            <!-- FINALIZAÇÃO (aparece SOMENTE quando status == Finalizado via JS) -->
            <div class="finalizacao-box" hidden>
              <div
                class="consultor-avaliacao"
                data-protocolo="{{ s.protocolo }}"
                data-origem="{{ s._origem }}"
              >
                <div class="consultor-avaliacao__title">Orientações para o cliente</div>

                <label class="consultor-label" style="margin-bottom:10px; margin-top:10px;">
                  Escreva orientações importantes <span class="req">*</span>
                </label>

                <textarea
                  class="consultor-textarea"
                  name="orientacoes_cliente_{{ s.protocolo }}"
                  data-protocolo="{{ s.protocolo }}"
                  rows="5"
                  placeholder="Ex: Comparecer com documento e guias de 5 dias, etc..."
                ></textarea>

                <div class="consultor-avaliacao__title" style="margin-top:14px;">
                  Anexar documento final em PDF
                </div>

                <div class="upload-box">
                  <input
                    id="final_pdf_{{ s.protocolo }}"
                    class="consultor-file"
                    type="file"
                    accept="application/pdf,.pdf"
                    data-protocolo="{{ s.protocolo }}"
                    data-origem="{{ s._origem }}"
                  />

                  <!-- o label vira a área clicável -->
                  <label class="upload-ui" for="final_pdf_{{ s.protocolo }}">
                    <div class="upload-ico" aria-hidden="true">
                      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none">
                        <path d="M12 16V4" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
                        <path d="M7 9l5-5 5 5" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M4 20h16" stroke="#64748b" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </div>

                    <div class="upload-txt">
                      <div class="upload-title">Arraste e solte o PDF aqui</div>
                    </div>
                  </label>

                  <div class="upload-filename">Nenhum arquivo selecionado</div>
                </div>

                <div class="consultor-actions">
                  <!-- ✅ classe específica para salvar AVALIAÇÃO -->
                  <button
                    type="button"
                    class="btn-save-avaliacao"
                    data-protocolo="{{ s.protocolo }}"
                    data-origem="{{ s._origem }}"
                  >
                    Salvar Avaliação
                  </button>
                </div>

                <div class="final-msg is-ok" hidden>
                  Aguarde
                </div>
              </div>
            </div>
            <!-- /FINALIZAÇÃO -->

          </div>
        </article>
        {% else %}
          <div class="empty-state" id="emptyState">Nenhuma solicitação encontrada.</div>
        {% endfor %}
      </section>
    </main>
  </body>
</html>
